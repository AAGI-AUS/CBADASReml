---
title: "Small-plot_analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Small-plot_analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(CBADASReml)
library(asreml)
```

# CBADASReml

## Introduction

A typical type of experimental analysis that this package will assist with is
the small plot trial. Here we will show the general workflow for performing a
small-plot analysis and how each function from the package can be used. Analysis
of small plot trials is done using linear mixed-effects models (LMMs), using \pkg{asreml}
or \pkg{glmmTMB}, and this package contains helper functions
for this type of modelling.

Note that the trial design is not handled at all by this package,
and we recommend the use of \pkg{FielDHub} for creating small plot trial
designs.

## Mathematical Background

Let:

\begin{equation*}
y
=
X b
+
Z u
+
e
\end{equation*}

Where

- $y \in \mathbb{R}^{n}$ is the vector of observations.
- $b \in \mathbb{R}^{p}$ is the vector of fixed effects.
- $X \in \mathbb{R}^{n \times p}$ is the design matrix for the fixed effects.
- $u \in \mathbb{R}^{q}$ is the vector of random effects.
- $Z \in \mathbb{R}^{n \times q}$ is the design matrix for the random effects.
- $e \in \mathbb{R}^{n}$ is the vector of residuals.

It is assumed that the vectors $u$ and $e$ are independent, and their joint
distribution is a multivariate Gaussian described by:

\begin{equation*}
\begin{bmatrix}
u \\
e
\end{bmatrix}
\sim
N \bigg(
  \begin{bmatrix}
  0 \\
  0
  \end{bmatrix}
  ,
  \begin{bmatrix}
  G & 0 \\
  0 & R
  \end{bmatrix}
\bigg)
\end{equation*}

Where $G$ and $R$ are covariance matrices for $u$ and $e$ and are functions of
the *variance parameters* $\sigma_g$ and $\sigma_r$, and finally the dependent
variable $y$ is described by:

\begin{equation*}
y
\sim
N \big(
X b
,
Z G Z^\intercal
+
R
\big)
\end{equation*}

These $G$ and $R$ covariance matrices, or *covariance structures*, are very
important. These represent the covariance of the random effects and the
residuals respectively, and $\sigma_g$ and $\sigma_r$, the *covariance
structure parameters* are the things we try and estimate when we use ASReml.

In the case of independent and identically distributed (IID) residual
structures, the residual covariance parameter $\sigma_r$ will be some *variance
component* $\sigma_e^2$.

### Exploratory Data Analysis

After gathering data from the experiment, it is useful to perform an
exploratory data analysis on the raw data, and for this you will likely use a
combination of \pkg{tidyverse} and \pkg{ggplot2} for this, to visualise
outliers, the data distribution, etc. in order to get a preliminary grasp of
what you are working with, and to observe the data for any issues that will
hinder the actual analysis. As an assistance with this process, the function `exploratory_table` is provided.

```{r}
CBADASReml::exploratory_table(data = oats,
                              response = "yield",
                              groupby = c("Variety", "Nitrogen"))
```

### Model Fitting and Validation

We may use the R package \pkg{asreml} as follows to implement an LMM.
For the purpose of this vignette we will fit a few different models, so we can demonstrate different techniques from the package.

```{r}
# The needs to be ordered so that the model can run
oats <- oats[order(oats$Column),]

mod_oats <- asreml(
    fixed = yield ~ Variety + Nitrogen + Variety:Nitrogen,
    random = ~ idv(Blocks) + idv(Blocks):idv(Wplots),
    residual = ~ ar1(Column):ar1(Row),
    data = oats,
    trace = FALSE
)

mod_oats <- update(mod_oats, aom = T)

mod_rats <- asreml(
    fixed = weight ~ littersize + Sex + Dose,
    random = ~idv(Dam),
    residual = ~units,
    data = rats,
    trace = FALSE
)

mod_rats <- update(mod_rats, aom = T)
```

In the first model, `mod_oats`, we are using the `oats` data:

- `yield` is our $y \in \mathbb{R}^n$ vector.
- `Variety`, `Nitrogen` and their interaction `Variety:Nitrogen` are in the $X
  \in \mathbb{R}^{n \times 3}$ matrix.
- `Blocks` and `Blocks:Wplots` are in the $Z$ matrix. We specify the `idv`
  variance model function, which is the homogeneous scaled identity variance
  structure, i.e. $\sigma^2 I$. In other words, the term is IID:
  + $u_b \in \mathbb{R}^b \sim N(0, \sigma_b^2 I_b)$
  + $u_{bp} \in \mathbb{R}^{bp} \sim N(0, \sigma_{bp}^2 I_{bp})$
  + $u \in \mathbb{R}^{b + bp} = [ \; u_b^\intercal \; u_{bp}^\intercal \;
    ]^\intercal$
  + $Z = [ \; Z_b \; Z_{bp} \; ]$ (the design matrices for `Blocks` and
    `Blocks:Wplots`)
  + Therefore, $G = \bigoplus_{i = 1}^2 G_i = \begin{bmatrix} \sigma_b^2 I_b &
    0 \\ 0 & \sigma_{bp}^2 I_{bp} \end{bmatrix}$
- `ar1(Column):ar1(Row)` is the residual variance structure. In this case we
  refer to an autoregressive model of order 1 (AR(1)) on both `Row` and
  `Column`, where the `:` operator implies a separable Kronecker product
  structure. The variance model `ar1` is of the form: $\Sigma_{ii} = 1,
  \Sigma_{ij} = \phi \Sigma_{i-1, j}, i > j+1, \lvert \phi \rvert < 1$.
  + $e_c \in \mathbb{R}^c \sim N(0, \Sigma_c(\phi))$
  + $e_r \in \mathbb{R}^r \sim N(0, \Sigma_r(\phi))$
  + $e = [ \; e_c^\intercal \; e_r^\intercal \; ]^\intercal$
  + Therefore, $R \in \mathbb{R}^{c \times r} = \bigotimes_{i=1}^2 R_i =
    \Sigma_c(\phi) \otimes \Sigma_r(\phi)$

In the second model, `mod_rats`, we are using the `rats` data:

- `weight` is our $y$ vector.
- `littersize`, `Sex` and `Dose` are in the $X$ matrix.
- `Dam` is in the $Z$ matrix. We specify the `idv` variance model function,
  which is the homogeneous scaled identity variance structure, i.e. $\sigma^2
  I$. In other words, the term is IID:
  + $u \in \mathbb{R}^d \sim N(0, \sigma_d^2 I_d)$
  + $Z$ is the design matrix for `Dam`.
  + Therefore, $G = \sigma_d^2 I_d$.
- `idv(units)` is the residual variance structure, in this case the residual
  term has the homogeneous covariance matrix: $\sigma^2 I$. This is basically
  saying all observations have the same error distribution (IID):
  + $e \in \mathbb{R}^n \sim N(0, \sigma_e^2 I_n)$
  + Therefore, $R = \sigma_e^2 I_n$, the simplest $R$ structure.

Upon executing the above in R, the \pkg{ASReml-R} code will attempt to
*estimate* the variance components $\sigma_d^2$ and $\sigma_e^2$, using the
REML algorithm.

### Traditional Diagnostics (available in \pkg{ASReml-R})

#### `plot.asreml`
```{r}
plot(mod_oats)
```

#### `plot(varioGram(mod))`
```{r}
plot(varioGram(mod_oats))
```

### CBADASReml Diagnostics

#### `outlier_summary`

The purpose of the `outlier_summary` function is to observe potential outliers that can then be discussed with the data provider. Below is an example for the rats dataset that is included within asrmel.

```{r}
outlier_summary(mod_rats)
```

#### `directional_variograms`

The purpose of this function is to view the autocorrelation structure in both directions, rather than the traditional approach with asreml.

```{r}
plot(directional_variograms(mod_oats))
```

## Model Outputs

### Traditional Output (available in asreml)

#### `wald`

For getting the significance of each variable in the model
```{r}
wald(mod_rats)
```

#### `predict`

```{r}
predict.asreml(mod_oats, classify = "Nitrogen")
```
